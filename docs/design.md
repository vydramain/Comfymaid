# Дизайн‑док: вертикальный срез (Hub + BossRoom)

## 0) Краткая суть
Минимальный 2D прототип (Godot 4.x), где:
- Игрок появляется в Hub.
- Общается с хранительницей (диалог с typewriter).
- Открывает спуск в подземелье.
- Переходит через белый экран, синхронизированный с музыкальными тактами.
- В BossRoom дерется с кругликом, который умирает и встает снова.
- При смерти игрока или после ключевого события идет полный ресет мира.

## 1) Жесткие ограничения
- 2D, без сложной анимации, без внешних ассетов.
- Никакого инвентаря, квестов, прокачки, сохранений.
- Только базовые механики: ходьба, прыжок, удар.
- Музыка/эмбиент — системные слои, без сложной интеграции.

## 2) Управление (Gamepad‑first)
- Движение: левый стик X
- Прыжок: Cross (X)
- Атака: Square
- Взаимодействие/подтверждение: Triangle
- Опционально: Reset (для теста)

Дополнительно (дебаг): клавиатура A/D, Space, J, E.

## 3) Глобальная машина состояний (GameDirector)
Состояния:
- HUB_FREE
- HUB_DIALOGUE
- TRANSITION_WHITEOUT
- BOSSROOM_FREE
- BOSS_FIGHT
- RESET

Переходы:
- HUB_FREE -> HUB_DIALOGUE (взаимодействие с хранительницей)
- HUB_DIALOGUE -> HUB_FREE (диалог завершен)
- HUB_FREE -> TRANSITION_WHITEOUT (дверь/спуск)
- TRANSITION_WHITEOUT -> BOSSROOM_FREE
- BOSSROOM_FREE -> BOSS_FIGHT (вход в зону босса)
- BOSS_FIGHT -> RESET (смерть игрока)
- RESET -> HUB_FREE

Важно:
- Диалог не останавливает мир, только блокирует управление игроком.
- RESET использует тот же пайплайн, что и переходы между сценами.

## 4) Игрок
### 4.1 Движение (HK‑like)
- ускорение/замедление
- гравитация
- coyote time
- jump buffer
- ограничение скорости падения
- без рывка и wall‑jump

### 4.2 Атака
- Кнопка атаки создаёт/включает полусферический хитбокс перед игроком.
- Атака работает в воздухе и на земле.
- При попадании: цель мигает белым, получает i‑frames.

Экспортируемые параметры:
- attack_cooldown
- attack_radius
- attack_offset
- iframes_duration
- damage_amount

### 4.3 Урон игрока
- При получении урона игрок тоже получает i‑frames.
- Смерть игрока запускает полный ресет мира через белый экран.

## 5) Босс (круглик)
- CharacterBody2D
- Простой AI: Idle -> Dash -> Recover
- Имеет HP
- Когда HP = 0:
  - короткая анимация смерти (сжатие/вспышка)
  - пауза ~0.8s
  - восстановление (ревив), HP сбрасывается
  - музыка босса не меняется

После первого «убийства» показывается оверлей:
"Советы по игре будут?"

Оверлей не блокирует управление и не останавливает бой.

## 6) Диалоги (Undertale‑like)
### 6.1 UX
- Окно диалога + typewriter в реальном времени
- Подтверждение той же кнопкой Triangle
- Подтверждение возможно только после окончания печати
- Мир продолжает жить, но игрок не может двигаться

### 6.2 Логика хранительницы
Сценарий:
1) Intro (один раз) -> после окончания открывает дверь
2) Extra lines (по очереди)
3) Repeat line (повторяется бесконечно)

## 7) Интеракция
- Взаимодействие только по кнопке Triangle.
- При входе в область — появляется подсказка:
  - "△ Talk" для NPC
  - "△ Enter" для дверей

InteractionResolver:
- Отслеживает ближайший интерактивный объект.
- Если диалог активен, Triangle = confirm.
- Иначе Triangle вызывает interact() объекта.

## 8) Аудио‑система (AudioDirector)
### 8.1 Принципы
- Эмбиент и музыка играют одновременно.
- Музыка состоит из слоев (base + 2 слоя).
- Слои в Hub зависят от дистанции до хранительницы.

### 8.2 Дистанция
- Радиус‑фейд: чем ближе к хранительнице, тем громче слои.

### 8.3 Диалог
- Во время диалога все слои плавно уходят в 0.
- Анимация хранительницы меняется на «не играет».

### 8.4 Переходы и такты
- Музыка нарезана на 4‑секундные лупы.
- Белый экран ждет окончания текущего бара:
  - time_to_next_bar = 4.0 - (elapsed % 4.0)
- После ожидания:
  - фейд старого эмбиента
  - смена сцены
  - запуск нового эмбиента + музыки

## 9) Камера
- Camera2D с deadzone (мертвой зоной).
- Камера ограничена bounds сцены.
- Игрок обычно в центре, но может смещаться к краям при упоре.

## 10) Сцены
### Main.tscn
- UI: DialogueUI, PromptUI, WhiteoutUI
- GameDirector + AudioDirector + SceneManager
- Старт в Hub

### Hub.tscn
- Статическая платформа + 1‑2 тестовые платформы
- Marker2D "PlayerSpawn"
- Хранительница слева
- Дверь/спуск справа (закрыта до диалога)

### BossRoom.tscn
- Арена + стены
- Marker2D "PlayerSpawn"
- Marker2D "BossSpawn"
- Boss instance
- Exit door (опционально)

## 11) Визуальный язык
- Белый экран = переход / ресет
- Хранительница играет = музыка жива
- Хранительница молчит = слои убраны
- Босс оживает = цикл не сломан

## 12) Данные (минимум)
### Диалоги (JSON)
{
  "id": "guardian",
  "intro": [
    {"speaker":"guardian","text":"..."}
  ],
  "extra": [
    {"speaker":"guardian","text":"..."}
  ],
  "repeat": {"speaker":"guardian","text":"..."}
}

### Аудио (JSON)
{
  "scene": "Hub",
  "layers": [
    {"name":"base", "volume":1.0, "distance_fade":false},
    {"name":"layer1", "volume":1.0, "distance_fade":true, "min":0, "max":600},
    {"name":"layer2", "volume":1.0, "distance_fade":true, "min":0, "max":600}
  ],
  "loop_length_sec": 4.0
}

## 13) Не закрытые вопросы (минимальные)
1) Прогресс диалога хранительницы сбрасывается при каждом ресете или нет?
2) Дверь в подземелье сбрасывается после ресета или остается открытой?
3) Оверлей "Советы по игре будут?" — в том же UI, что диалог, или отдельный HUD‑слой?
4) Есть ли визуальная анимация смерти игрока перед белым экраном?
